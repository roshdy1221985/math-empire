<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ููุญุฉ ุงูุชุญูู ุงูููููุฉ | ุงูุฃุณุชุงุฐ ุฑุดุฏู ุณูุฏ</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Amiri:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #d4af37;
            --gold-grad: linear-gradient(45deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            --bg: #040d21;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(212, 175, 55, 0.3);
        }

        body { margin: 0; font-family: 'Cairo', sans-serif; background: var(--bg); color: #fff; overflow-x: hidden; }

        /* ุดุงุดุฉ ุงูุฏุฎูู */
        #login-overlay {
            position: fixed; inset: 0; background: radial-gradient(circle, #1a1a2e, #000);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .login-box {
            background: var(--glass); padding: 40px; border-radius: 30px; border: 1px solid var(--gold);
            text-align: center; width: 350px; backdrop-filter: blur(15px);
        }

        /* ุงููููู ุงูุฑุฆูุณู */
        #admin-panel { display: none; min-height: 100vh; display: flex; }
        .sidebar { 
            width: 280px; background: #000; border-left: 1px solid var(--border); 
            padding: 40px 20px; position: sticky; top: 0; height: 100vh; display: flex; flex-direction: column;
        }
        
        .nav-link {
            padding: 15px 20px; margin-bottom: 10px; border-radius: 12px; cursor: pointer;
            transition: 0.3s; display: flex; align-items: center; gap: 12px; color: rgba(255,255,255,0.7);
        }
        .nav-link:hover, .nav-link.active { background: var(--glass); color: var(--gold); border-right: 5px solid var(--gold); }

        .main-content { flex: 1; padding: 40px; overflow-y: auto; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.5s ease; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--glass); padding: 30px; border-radius: 25px; border: 1px solid var(--border); margin-bottom: 25px; }
        label { color: var(--gold); font-weight: bold; display: block; margin-top: 15px; }
        input, select, textarea { 
            width: 100%; padding: 12px; margin-top: 8px; border-radius: 10px; 
            background: #0d1b3a; color: #fff; border: 1px solid var(--gold); font-family: 'Cairo'; box-sizing: border-box;
        }

        /* ุชุตููู ูุงุฆูุฉ ุงูุฏุฑูุณ ุงููุชุนุฏุฏุฉ */
        .multi-select-container {
            width: 100%; max-height: 200px; overflow-y: auto; margin-top: 8px;
            background: #0d1b3a; border: 1px solid var(--gold); border-radius: 10px; padding: 10px; box-sizing: border-box;
        }
        .multi-select-unit { color: var(--gold); font-weight: bold; margin-top: 10px; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        .multi-select-lesson { display: flex; align-items: center; gap: 10px; padding: 5px 10px; cursor: pointer; transition: 0.2s; }
        .multi-select-lesson:hover { background: rgba(212,175,55,0.1); border-radius: 5px; }
        .multi-select-lesson input { width: auto; margin: 0; cursor: pointer; }
        
        .btn-gold { 
            background: var(--gold-grad); color: #000; border: none; padding: 15px; 
            border-radius: 12px; font-weight: 900; cursor: pointer; width: 100%; font-size: 1.1rem; margin-top: 25px;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: rgba(0,0,0,0.2); }
        th { background: rgba(212,175,55,0.1); color: var(--gold); padding: 15px; text-align: right; border-bottom: 1px solid var(--gold); }
        td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }

        .home-btn { 
            margin-top: auto; background: rgba(255,255,255,0.05); color: #fff; 
            border: 1px solid var(--border); padding: 12px; border-radius: 10px; text-decoration: none;
            display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: bold;
        }

        /* ุงูุฅุญุตุงุฆูุงุช */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px; }
        .stat-box { background: rgba(0,0,0,0.4); padding: 25px; border-radius: 20px; border: 1px solid var(--border); text-align: center; }
        .stat-box div:first-child { color: rgba(255,255,255,0.8); font-size: 1.1rem; margin-bottom: 10px; }
        .stat-number { font-size: 2.5rem; color: var(--gold); font-weight: 900; font-family: 'Amiri'; }
        .crown-icon { font-size: 1.5rem; color: var(--gold); }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="color:var(--gold); font-family:'Amiri';">ุฎุฒูุฉ ุงูุฃุณุชุงุฐ ุฑุดุฏู</h2>
            <p>ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ ุงูุณุฑูุฉ</p>
            <input type="password" id="pass-input" placeholder="ูููุฉ ุงููุฑูุฑ">
            <button class="btn-gold" onclick="checkLogin()">ุฏุฎูู ุงูุฅูุจุฑุงุทูุฑูุฉ ๐๏ธ</button>
        </div>
    </div>

    <div id="admin-panel">
        <aside class="sidebar">
            <div style="text-align:center; margin-bottom:40px;">
                <h2 style="color:var(--gold); font-family:'Amiri'; margin:0;">ููุญุฉ ุงูุชุญูู</h2>
                <small>ูุฏุฑุณุฉ ุงูุดูุฎ ุณุนูุฏ ุจู ุฃุญูุฏ</small>
            </div>
            
            <div class="nav-link" onclick="showSection('dash')">๐ ุงูุฅุญุตุงุฆูุงุช ุงูุนุงูุฉ</div>
            <div class="nav-link" onclick="showSection('students')">๐ก๏ธ ูุฑุงูุจุฉ ุงูุฑุนูุฉ</div>
            <div class="nav-link" onclick="showSection('scrolls')">๐ ููุงุฆู ุงููุนุฑูุฉ (PDF)</div>
            <div class="nav-link active" onclick="showSection('bank')">๐ ุจูู ุงูุฃุณุฆูุฉ ุงููููู</div>
            <div class="nav-link" onclick="showSection('exams')">โณ ุฌุฏููุฉ ุงูุงุฎุชุจุงุฑุงุช</div>
            <div class="nav-link" onclick="showSection('reports')">๐ ุงูุชูุงุฑูุฑ ุงูุดูุฑูุฉ</div>

            <a href="student.html" class="home-btn">๐ ุงูุนูุฏุฉ ููููุตุฉ ุงูุฑุฆูุณูุฉ</a>
        </aside>

        <main class="main-content">
            <header>
                <h1 style="color:var(--gold); font-family:'Amiri'; font-size:2.5rem; margin:0;">ุฃููุงู ุจูุ ุฃุณุชุงุฐ ุฑุดุฏู ุณูุฏ</h1>
            </header>

            <section id="dash" class="section">
                <div class="card">
                    <h2 style="color:var(--gold); margin-top: 0;">๐๏ธ ูุธุฑุฉ ุนุงูุฉ ุนูู ุงูุฅูุจุฑุงุทูุฑูุฉ</h2>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div>๐ฅ ุฅุฌูุงูู ุงูุฑุนูุฉ (ุงูุทูุงุจ)</div>
                            <div class="stat-number" id="stat-total-students">0</div>
                        </div>
                        <div class="stat-box" style="border-color: var(--gold); background: rgba(212,175,55,0.05);">
                            <div>๐ ุณูุทุงู ุงูุฃุฑูุงู ุงูุญุงูู</div>
                            <div class="stat-number" id="stat-top-student" style="font-size:1.8rem;">ูุง ููุฌุฏ</div>
                            <div id="stat-top-xp" style="color: var(--gold); font-size: 1rem; margin-top: 5px;">0 XP</div>
                        </div>
                        <div class="stat-box">
                            <div>โญ ูุชูุณุท ุงูููุงุท</div>
                            <div class="stat-number" id="stat-avg-xp">0</div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="students" class="section">
                <div class="card">
                    <h2 style="color:var(--gold); margin-top: 0;">๐ก๏ธ ุณุฌู ุงูุฃุจุทุงู (ูุฑุงูุจุฉ ุงูุฑุนูุฉ)</h2>
                    <p style="opacity: 0.8;">ูุงุฆูุฉ ุจุฌููุน ุงูุทูุงุจ ุงููุณุฌููู ูู ููุตุชู (ูุชู ุฌูุจูุง ูู ุงููุชุตูุญ ุงููุญูู).</p>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>ุงูุจุทู</th>
                                <th>ุงููุฏุฑุณุฉ</th>
                                <th>ุงูููุงุท (XP)</th>
                                <th>ุงูุฑุชุจุฉ</th>
                            </tr>
                        </thead>
                        <tbody id="students-table-body">
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="scrolls" class="section">
                <div class="card">
                    <h2 style="color:var(--gold);">๐ ุฅูุฏุงุน ููุงูุฉ ูุนุฑูุฉ ุฌุฏูุฏุฉ (PDF)</h2>
                    <p>ูู ุจุฑูุน ููุฎุต ุงูุฏุฑุณ ููุธูุฑ ููุทูุงุจ ูุจู ุจุฏุก ุงูุชุญุฏูุงุช.</p>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div>
                            <label>๐ ุงูุฏุฑุณ ุงููุณุชูุฏู</label>
                            <select id="pdf-lesson-select">
                                <option value="">-- ุงุฎุชุฑ ุงูุฏุฑุณ --</option>
                                <optgroup label="ุงููุญุฏุฉ ุงูุฃููู: ุงูููุงุณ">
                                    <option value="17-1 ููุงุณ ุงููุชูุฉ ูุงูุณุนุฉ (1)">17-1 ููุงุณ ุงููุชูุฉ ูุงูุณุนุฉ (1)</option>
                                    <option value="17-2 ููุงุณ ุงููุชูุฉ ูุงูุณุนุฉ (2)">17-2 ููุงุณ ุงููุชูุฉ ูุงูุณุนุฉ (2)</option>
                                    <option value="18-1 ุชุญููู ุงูููุช">18-1 ุชุญููู ุงูููุช</option>
                                    <option value="18-2 ุงูููุงุทู ุงูุฒูููุฉ (1)">18-2 ุงูููุงุทู ุงูุฒูููุฉ (1)</option>
                                    <option value="19-1 ุญุณุงุจ ุงููุณุงุญุฉ ูุงููุญูุท">19-1 ุญุณุงุจ ุงููุณุงุญุฉ ูุงููุญูุท</option>
                                </optgroup>
                                <optgroup label="ุงููุญุฏุฉ ุงูุซุงููุฉ: ูุนุงูุฌุฉ ุงูุจูุงูุงุช">
                                    <option value="20-1 ุงูุฌุฏุงูู ูุงูุฑุณููุงุช ุงูุจูุงููุฉ">20-1 ุงูุฌุฏุงูู ูุงูุฑุณููุงุช ุงูุจูุงููุฉ</option>
                                    <option value="20-2 ุงููุฎุทุทุงุช ุงูุฏุงุฆุฑูุฉ">20-2 ุงููุฎุทุทุงุช ุงูุฏุงุฆุฑูุฉ</option>
                                    <option value="21-1 ุงููุชูุณุท ุงูุฅุญุตุงุฆู">21-1 ุงููุชูุณุท ุงูุฅุญุตุงุฆู</option>
                                    <option value="21-2 ุงุณุชุฎุฏุงู ุงูุฅุญุตุงุก">21-2 ุงุณุชุฎุฏุงู ุงูุฅุญุตุงุก</option>
                                    <option value="22-1 ูุบุฉ ุงูุงุญุชูุงู">22-1 ูุบุฉ ุงูุงุญุชูุงู</option>
                                </optgroup>
                                <optgroup label="ุงููุญุฏุฉ ุงูุซุงูุซุฉ: ุงูุนุฏุฏ">
                                    <option value="23-1 ูุธุงู ุงูุฃุนุฏุงุฏ (2)">23-1 ูุธุงู ุงูุฃุนุฏุงุฏ (2)</option>
                                    <option value="23-2 ุชุงุฑูุฎ ุงูุฃุนุฏุงุฏ (2)">23-2 ุชุงุฑูุฎ ุงูุฃุนุฏุงุฏ (2)</option>
                                    <option value="24-1 ุงูุฌูุน ูุงูุทุฑุญ (1)">24-1 ุงูุฌูุน ูุงูุทุฑุญ (1)</option>
                                    <option value="24-2 ุงูุถุฑุจ ูุงููุณูุฉ">24-2 ุงูุถุฑุจ ูุงููุณูุฉ</option>
                                    <option value="25-1 ุงูุฌูุน ูุงูุทุฑุญ (2)">25-1 ุงูุฌูุน ูุงูุทุฑุญ (2)</option>
                                    <option value="26-1 ููุงููู ุงูุญุณุงุจ">26-1 ููุงููู ุงูุญุณุงุจ</option>
                                    <option value="26-2 ุงููุณูุฑ ูุงููุณูุฉ">26-2 ุงููุณูุฑ ูุงููุณูุฉ</option>
                                    <option value="27-1 ุงููุณูุฑ">27-1 ุงููุณูุฑ</option>
                                    <option value="28-1 ุงููุณุจ ุงููุฆููุฉ">28-1 ุงููุณุจ ุงููุฆููุฉ</option>
                                    <option value="29-1 ุงููุณุจุฉ ูุงูุชูุงุณุจ">29-1 ุงููุณุจุฉ ูุงูุชูุงุณุจ</option>
                                </optgroup>
                                <optgroup label="ุงููุญุฏุฉ ุงูุฑุงุจุนุฉ: ุงูููุฏุณุฉ">
                                    <option value="33-1 ุงูููุดูุฑุงุช ุฑุจุงุนูุฉ ุงูุฃุถูุงุน">33-1 ุงูููุดูุฑุงุช ุฑุจุงุนูุฉ ุงูุฃุถูุงุน</option>
                                    <option value="33-2 ูุชุนุฏุฏ ุงูุฃูุฌู ุงูููุชุธู">33-2 ูุชุนุฏุฏ ุงูุฃูุฌู ุงูููุชุธู</option>
                                    <option value="34-1 ุชุตููู ุงูุฃุดูุงู">34-1 ุชุตููู ุงูุฃุดูุงู</option>
                                    <option value="35-1 ุฑุณู ูููุงุณ ุงูุฒูุงูุง">35-1 ุฑุณู ูููุงุณ ุงูุฒูุงูุง</option>
                                </optgroup>
                            </select>
                        </div>
                        <div>
                            <label>๐ ููู ุงูููุฎุต (PDF)</label>
                            <input type="file" id="pdf-file-input" accept=".pdf">
                        </div>
                    </div>
                    <button class="btn-gold" onclick="uploadSmartPDF()">ุฅูุฏุงุน ูู ุณุฌูุงุช ุงูุฎููุฏ ๐พ</button>
                    <div id="pdf-status" style="text-align:center; margin-top:10px; font-weight:bold;"></div>
                </div>

                <div class="card">
                    <h3 style="color:var(--gold);">๐ ุงูููุงุฆู ุงูููุฏุนุฉ ุญุงููุงู ูู ุงูุฎุฒูุฉ</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>ุงูุฏุฑุณ</th>
                                <th>ูุนุงููุฉ</th>
                                <th>ุฅุฌุฑุงุก</th>
                            </tr>
                        </thead>
                        <tbody id="pdfs-table-body">
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="bank" class="section active">
                <div class="card">
                    <h2 style="color:var(--gold);" id="form-title">๐จ ุฅุถุงูุฉ ุชุญุฏู ูููู ุฌุฏูุฏ</h2>
                    <input type="hidden" id="edit-id"> 
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div>
                            <label>๐ ุงููุญุฏุฉ ุงูุฏุฑุงุณูุฉ</label>
                            <select id="q-unit" onchange="updateLessons()">
                                <option value="">-- ุงุฎุชุฑ ุงููุญุฏุฉ --</option>
                                <option value="ุงููุญุฏุฉ ุงูุฃููู: ุงูููุงุณ (17-19)">ุงููุญุฏุฉ ุงูุฃููู: ุงูููุงุณ (17-19)</option>
                                <option value="ุงููุญุฏุฉ ุงูุซุงููุฉ: ูุนุงูุฌุฉ ุงูุจูุงูุงุช (20-22)">ุงููุญุฏุฉ ุงูุซุงููุฉ: ูุนุงูุฌุฉ ุงูุจูุงูุงุช (20-22)</option>
                                <option value="ุงููุญุฏุฉ ุงูุซุงูุซุฉ: ุงูุนุฏุฏ (23-29)">ุงููุญุฏุฉ ุงูุซุงูุซุฉ: ุงูุนุฏุฏ (23-29)</option>
                                <option value="ุงููุญุฏุฉ ุงูุฑุงุจุนุฉ: ุงูููุฏุณุฉ (33-35)">ุงููุญุฏุฉ ุงูุฑุงุจุนุฉ: ุงูููุฏุณุฉ (33-35)</option>
                            </select>
                        </div>
                        <div>
                            <label>๐ ุงูุฏุฑุณ</label>
                            <select id="q-lesson"><option value="">ุงุฎุชุฑ ุงููุญุฏุฉ ุฃููุงู</option></select>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:15px;">
                        <div>
                            <label>๐๏ธ ููุน ุงูุณุคุงู</label>
                            <select id="q-type" onchange="toggleOptions()">
                                <option value="choice">ุงุฎุชูุงุฑ ูู ูุชุนุฏุฏ ๐</option>
                                <option value="true_false">ุตูุงุจ ุฃู ุฎุทุฃ โ/โ</option>
                                <option value="short">ุฅุฌุงุจุฉ ูุตูุฑุฉ โ๏ธ</option> </select>
                        </div>
                        <div>
                            <label>๐ผ๏ธ ุตูุฑุฉ ุงูุณุคุงู (ุงุฎุชูุงุฑู)</label>
                            <input type="file" id="q-image" accept="image/*">
                        </div>
                    </div>

                    <label>๐ ูุต ุงูุณุคุงู</label>
                    <textarea id="q-text" rows="3" placeholder="ุงูุชุจ ุงูุณุคุงู ุงูุฑูุงุถู ููุง..."></textarea>
                    
                    <div id="options-container">
                        <label>๐ ุงูุฎูุงุฑุงุช (ุงูุตู ุจูููุง ุจูุงุตูุฉ , )</label>
                        <input type="text" id="q-options" placeholder="ูุซุงู: ูุชุฑ , ูููููุชุฑ , ุฌุฑุงู">
                    </div>

                    <label>โ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ</label>
                    <input type="text" id="q-answer" placeholder="ุงูุชุจ ุงูุฅุฌุงุจุฉ ุจุฏูุฉ">

                    <button class="btn-gold" id="save-btn" onclick="saveSmartQuestion()">ุญูุธ ูู ุงูุฎุฒูุฉ ุงูููููุฉ ๐พ</button>
                    <button id="cancel-btn" style="display:none; margin-top:10px; background:#444; color:white; border:none; padding:10px; border-radius:10px; width:100%; cursor:pointer;" onclick="resetForm()">ุฅูุบุงุก ุงูุชุนุฏูู</button>
                    <div id="status-msg" style="text-align:center; margin-top:10px; font-weight:bold;"></div>
                </div>

                <div class="card">
                    <h3>๐ ูุนุงููุฉ ูุฅุฏุงุฑุฉ ุงูุฃุณุฆูุฉ ุงูุญุงููุฉ</h3>
                    <table>
                        <thead>
                            <tr><th>ุงูุณุคุงู</th><th>ุงูุฏุฑุณ</th><th>ุงูุตูุฑุฉ</th><th>ุฅุฌุฑุงุก</th></tr>
                        </thead>
                        <tbody id="questions-table-body">
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="exams" class="section">
                <div class="card">
                    <h2 style="color:var(--gold); margin-top:0;">โณ ุฌุฏููุฉ ุงุฎุชุจุงุฑ (ุฃุณุจูุนู / ุดูุฑู)</h2>
                    <p>ุญุฏุฏ ููุนุฏ ุงูุงุฎุชุจุงุฑ ููุฏุชู ููุธูุฑ ูุฅุดุนุงุฑ ุชูุจููู ูููุชุญ ููุทุงูุจ ูู ุงูููุช ุงููุญุฏุฏ.</p>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div>
                            <label>๐ ุนููุงู ุงูุงุฎุชุจุงุฑ (ูุซุงู: ุงุฎุชุจุงุฑ ุดูุฑ ุฃูุชูุจุฑ)</label>
                            <input type="text" id="exam-title" placeholder="ุงุณู ุงูุงุฎุชุจุงุฑ">
                        </div>
                        <div>
                            <label>๐๏ธ ููุน ุงูุงุฎุชุจุงุฑ</label>
                            <select id="exam-type">
                                <option value="ุฃุณุจูุนู">ุงุฎุชุจุงุฑ ุฃุณุจูุนู</option>
                                <option value="ุดูุฑู">ุงุฎุชุจุงุฑ ุดูุฑู</option>
                            </select>
                        </div>
                        <div>
                            <label>๐ ุชุงุฑูุฎ ุงูุงุฎุชุจุงุฑ</label>
                            <input type="date" id="exam-date">
                        </div>
                        <div>
                            <label>โฐ ููุช ุงูุงุฎุชุจุงุฑ</label>
                            <input type="time" id="exam-time">
                        </div>
                        <div>
                            <label>โฑ๏ธ ูุฏุฉ ุงูุงุฎุชุจุงุฑ (ุจุงูุฏูุงุฆู)</label>
                            <input type="number" id="exam-duration" placeholder="ูุซุงู: 15" min="1" value="15">
                        </div>
                        
                        <div>
                            <label>๐ฏ ููุนูุฉ ุงูุฃุณุฆูุฉ ุงููุณุชูุฏูุฉ</label>
                            <select id="exam-target-q-type">
                                <option value="all">ุฌููุน ุงูุฃููุงุน (ุนุดูุงุฆู)</option>
                                <option value="choice">ุงุฎุชูุงุฑ ูู ูุชุนุฏุฏ ููุท ๐</option>
                                <option value="true_false">ุตูุงุจ ุฃู ุฎุทุฃ ููุท โ/โ</option>
                                <option value="short">ุฅุฌุงุจุฉ ูุตูุฑุฉ ููุท โ๏ธ</option>
                            </select>
                        </div>
                        <div>
                            <label>๐ข ุนุฏุฏ ุงูุฃุณุฆูุฉ ุงููุทููุจ ุณุญุจูุง</label>
                            <input type="number" id="exam-num-q" placeholder="ูุซุงู: 10" min="1" value="10">
                        </div>
                        <div>
                            <label>โญ ุฏุฑุฌุฉ ูู ุณุคุงู</label>
                            <input type="number" id="exam-points-q" placeholder="ูุซุงู: 10" min="1" value="10">
                        </div>
                        
                        <div style="grid-column: span 2;">
                            <label>๐ ุงูุฏุฑูุณ ุงููุณุชูุฏูุฉ (ููููู ุงุฎุชูุงุฑ ุฃูุซุฑ ูู ุฏุฑุณ)</label>
                            <div class="multi-select-container" id="exam-lesson-container">
                                </div>
                        </div>
                    </div>
                    <button class="btn-gold" onclick="scheduleExam()">ุฅุทูุงู ุงูุฅุดุนุงุฑ ุงููููู ๐</button>
                    <div id="exam-status" style="margin-top:10px; font-weight:bold; text-align:center;"></div>
                </div>

                <div class="card">
                    <h3 style="color:var(--gold);">๐ ุงูุงุฎุชุจุงุฑุงุช ุงููุฌุฏููุฉ ุญุงููุงู</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>ุงูุงุฎุชุจุงุฑ</th>
                                <th>ุงูุชุงุฑูุฎ ูุงูููุช</th>
                                <th>ุงูุฏุฑูุณ ุงููุณุชูุฏูุฉ</th>
                                <th>ุงููุฏุฉ</th>
                                <th>ุงูุฃุณุฆูุฉ ูุงูุฏุฑุฌุงุช</th>
                                <th>ุฅุฌุฑุงุก</th>
                            </tr>
                        </thead>
                        <tbody id="exams-table-body">
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="reports" class="section">
                <div class="card">
                    <h2>๐ ุงูุชูุงุฑูุฑ ูุงูุทุจุงุนุฉ</h2>
                    <button class="btn-gold" onclick="window.print()">ุทุจุงุนุฉ ุงูุชูุฑูุฑ ุงูุญุงูู ๐จ๏ธ</button>
                </div>
            </section>
        </main>
    </div>

<script>
    const SECRET_PASS = "Roshdy2026";
    const API_URL = "http://127.0.0.1:8000"; 
    let allQuestions = [];
    
    const lessonsMap = {
        "ุงููุญุฏุฉ ุงูุฃููู: ุงูููุงุณ (17-19)": [
            "17-1 ููุงุณ ุงููุชูุฉ ูุงูุณุนุฉ (1)", "17-2 ููุงุณ ุงููุชูุฉ ูุงูุณุนุฉ (2)",
            "18-1 ุชุญููู ุงูููุช", "18-2 ุงูููุงุทู ุงูุฒูููุฉ (1)", "19-1 ุญุณุงุจ ุงููุณุงุญุฉ ูุงููุญูุท"
        ],
        "ุงููุญุฏุฉ ุงูุซุงููุฉ: ูุนุงูุฌุฉ ุงูุจูุงูุงุช (20-22)": [
            "20-1 ุงูุฌุฏุงูู ูุงูุฑุณููุงุช ุงูุจูุงููุฉ", "20-2 ุงููุฎุทุทุงุช ุงูุฏุงุฆุฑูุฉ",
            "21-1 ุงููุชูุณุท ุงูุฅุญุตุงุฆู", "21-2 ุงุณุชุฎุฏุงู ุงูุฅุญุตุงุก", "22-1 ูุบุฉ ุงูุงุญุชูุงู"
        ],
        "ุงููุญุฏุฉ ุงูุซุงูุซุฉ: ุงูุนุฏุฏ (23-29)": [
            "23-1 ูุธุงู ุงูุฃุนุฏุงุฏ (2)", "23-2 ุชุงุฑูุฎ ุงูุฃุนุฏุงุฏ (2)", "24-1 ุงูุฌูุน ูุงูุทุฑุญ (1)",
            "24-2 ุงูุถุฑุจ ูุงููุณูุฉ", "25-1 ุงูุฌูุน ูุงูุทุฑุญ (2)", "26-1 ููุงููู ุงูุญุณุงุจ",
            "26-2 ุงููุณูุฑ ูุงููุณูุฉ", "27-1 ุงููุณูุฑ", "28-1 ุงููุณุจ ุงููุฆููุฉ", "29-1 ุงููุณุจุฉ ูุงูุชูุงุณุจ"
        ],
        "ุงููุญุฏุฉ ุงูุฑุงุจุนุฉ: ุงูููุฏุณุฉ (33-35)": [
            "33-1 ุงูููุดูุฑุงุช ุฑุจุงุนูุฉ ุงูุฃุถูุงุน", "33-2 ูุชุนุฏุฏ ุงูุฃูุฌู ุงูููุชุธู",
            "34-1 ุชุตููู ุงูุฃุดูุงู", "35-1 ุฑุณู ูููุงุณ ุงูุฒูุงูุง"
        ]
    };

    function renderExamLessonCheckboxes() {
        const container = document.getElementById('exam-lesson-container');
        let html = '';
        for(let unit in lessonsMap) {
            html += `<div class="multi-select-unit">${unit}</div>`;
            lessonsMap[unit].forEach(lesson => {
                html += `
                <label class="multi-select-lesson">
                    <input type="checkbox" value="${lesson}" class="exam-lesson-cb"> 
                    ${lesson}
                </label>`;
            });
        }
        container.innerHTML = html;
    }

    function checkLogin() {
        if(document.getElementById('pass-input').value === SECRET_PASS) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'flex';
            loadQuestions();
            loadDashboardData(); 
            renderExamLessonCheckboxes();
        } else { alert("โ๏ธ ูููุฉ ูุฑูุฑ ุฎุงุทุฆุฉ!"); }
    }

    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        
        const links = document.querySelectorAll('.nav-link');
        links.forEach(link => {
            if(link.getAttribute('onclick').includes(id)) link.classList.add('active');
        });

        if(id === 'bank') loadQuestions();
        if(id === 'dash' || id === 'students') loadDashboardData();
        if(id === 'scrolls') loadPDFs(); 
        if(id === 'exams') loadScheduledExams();
    }

    function getRankTitle(xp) {
        if (xp >= 3000) return "๐ ุณูุทุงู ุงูุฃุฑูุงู";
        if (xp >= 1500) return "๐งโโ๏ธ ุงููุฒูุฑ ุงูุญููู";
        if (xp >= 500) return "โ๏ธ ูุงุฑุณ ุงูุฑูุงุถูุงุช";
        if (xp >= 100) return "๐ก๏ธ ุฌูุฏู ุดุฌุงุน";
        return "ูุณุชูุดู ุฌุฏูุฏ";
    }

    function loadDashboardData() {
        let allStudents = JSON.parse(localStorage.getItem('allMathHeroes')) || [];
        const singleHero = JSON.parse(localStorage.getItem('mathHero'));
        
        if (singleHero && !allStudents.find(s => s.username === singleHero.username)) {
            if(!singleHero.xp) singleHero.xp = Math.floor(Math.random() * 2000); 
            allStudents.push(singleHero);
        }

        allStudents.sort((a, b) => (b.xp || 0) - (a.xp || 0));

        const totalStudents = allStudents.length;
        const topStudent = allStudents.length > 0 ? allStudents[0] : null;
        const totalXP = allStudents.reduce((sum, student) => sum + (student.xp || 0), 0);
        const avgXP = totalStudents > 0 ? Math.floor(totalXP / totalStudents) : 0;

        document.getElementById('stat-total-students').innerText = totalStudents;
        if (topStudent) {
            document.getElementById('stat-top-student').innerText = topStudent.full_name || topStudent.username;
            document.getElementById('stat-top-xp').innerText = `${topStudent.xp || 0} XP`;
        }
        document.getElementById('stat-avg-xp').innerText = avgXP;

        const tbody = document.getElementById('students-table-body');
        if(allStudents.length === 0) {
            tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; opacity:0.6;">ูุง ููุฌุฏ ุทูุงุจ ูุณุฌููู ุญุชู ุงูุขู. ูุฌุจ ุนูููู ุงูุชุณุฌูู ูู ุตูุญุฉ ุงูุทุงูุจ ุฃููุงู.</td></tr>`;
        } else {
            tbody.innerHTML = allStudents.map((student, index) => {
                const rank = getRankTitle(student.xp || 0);
                const isTop = index === 0 ? '<span class="crown-icon">๐</span> ' : '';
                return `
                    <tr>
                        <td style="font-weight: bold; color: var(--gold);">${isTop}${student.full_name || student.username}</td>
                        <td>${student.school_name || 'ูุฏุฑุณุฉ ุงูุดูุฎ ุณุนูุฏ ุจู ุฃุญูุฏ'}</td>
                        <td style="font-weight: bold;">${student.xp || 0}</td>
                        <td>${rank}</td>
                    </tr>
                `;
            }).join('');
        }
    }

    function updateLessons() {
        const unit = document.getElementById('q-unit').value;
        const sel = document.getElementById('q-lesson');
        sel.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงูุฏุฑุณ --</option>';
        if(unit && lessonsMap[unit]) {
            lessonsMap[unit].forEach(l => sel.innerHTML += `<option value="${l}">${l}</option>`);
        }
    }

    function toggleOptions() {
        const type = document.getElementById('q-type').value;
        document.getElementById('options-container').style.display = (type === 'choice') ? 'block' : 'none';
    }

    async function scheduleExam() {
        const title = document.getElementById('exam-title').value;
        const type = document.getElementById('exam-type').value;
        const date = document.getElementById('exam-date').value;
        const time = document.getElementById('exam-time').value;
        const duration = document.getElementById('exam-duration').value; 
        const num_q = document.getElementById('exam-num-q').value; 
        const points_q = document.getElementById('exam-points-q').value;
        const target_q_type = document.getElementById('exam-target-q-type').value;
        const selectedLessonCbs = document.querySelectorAll('.exam-lesson-cb:checked');
        const selectedLessonsArray = Array.from(selectedLessonCbs).map(cb => cb.value);
        const lesson = selectedLessonsArray.join(',');
        const status = document.getElementById('exam-status');

        if(!title || !date || !time || selectedLessonsArray.length === 0 || !duration || !num_q || !points_q) {
            status.style.color = "#ff5e5e";
            status.innerText = "โ๏ธ ูุฑุฌู ููุก ูุงูุฉ ุงูุจูุงูุงุช ูุงุฎุชูุงุฑ ุฏุฑุณ ูุงุญุฏ ุนูู ุงูุฃูู!";
            return;
        }

        const fd = new FormData();
        fd.append('title', title); 
        fd.append('exam_type', type);
        fd.append('exam_date', date); 
        fd.append('exam_time', time);
        fd.append('target_lesson', lesson);
        fd.append('duration', duration); 
        fd.append('num_questions', num_q); 
        fd.append('points_per_q', points_q); 
        fd.append('target_q_type', target_q_type); 

        try {
            status.style.color = "var(--gold)";
            status.innerText = "ุฌุงุฑู ุฅุทูุงู ุงูุฅุดุนุงุฑ...";
            const res = await fetch(`${API_URL}/api/admin/exams`, { method: 'POST', body: fd });
            if (res.ok) {
                status.innerText = "โ ุชู ุฌุฏููุฉ ุงูุงุฎุชุจุงุฑ ูุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช ุจูุฌุงุญ!";
                status.style.color = "#00ff00";
                document.getElementById('exam-title').value = '';
                document.getElementById('exam-duration').value = '15'; 
                document.getElementById('exam-num-q').value = '10'; 
                document.getElementById('exam-points-q').value = '10'; 
                document.getElementById('exam-target-q-type').value = 'all'; 
                selectedLessonCbs.forEach(cb => cb.checked = false);
                loadScheduledExams();
            } else { status.innerText = "โ ูุดูุช ุนูููุฉ ุงูุฌุฏููุฉ."; status.style.color = "#ff5e5e"; }
        } catch(e) { status.innerText = "โ๏ธ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู."; status.style.color = "#ff5e5e"; }
    }

    async function loadScheduledExams() {
        try {
            const res = await fetch(`${API_URL}/api/exams/upcoming`);
            const exams = await res.json();
            const tbody = document.getElementById('exams-table-body');
            if (exams.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; opacity:0.6;">ูุง ุชูุฌุฏ ุงุฎุชุจุงุฑุงุช ูุฌุฏููุฉ ุญุงููุงู.</td></tr>`;
                return;
            }
            tbody.innerHTML = exams.map(e => `
                <tr>
                    <td style="font-weight:bold; color:var(--gold);">${e.title}<br><small style="color:#aaa;">(${e.exam_type})</small></td>
                    <td style="direction:ltr;">${e.exam_date} | ${e.exam_time}</td>
                    <td><small>${e.target_lesson.substring(0, 30)}${e.target_lesson.length > 30 ? '...' : ''}</small></td>
                    <td>${e.duration} ุฏูููุฉ</td> 
                    <td>${e.num_questions} ุณุคุงู (${e.points_per_q} ููุทุฉ ูููุงุญุฏ)</td>
                    <td><button onclick="deleteExam(${e.id})" style="background:#ff5e5e; color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer; font-weight:bold;">ุฅูุบุงุก ๐๏ธ</button></td>
                </tr>`).join('');
        } catch(e) { console.error("Error fetching exams:", e); }
    }

    async function deleteExam(id) {
        if(confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุฅูุบุงุก ูุฐุง ุงูุงุฎุชุจุงุฑุ ูู ูุธูุฑ ูุฅุดุนุงุฑ ููุทูุงุจ ุจุนุฏ ุงูุขู.")) {
            try {
                await fetch(`${API_URL}/api/admin/exams/${id}`, { method: 'DELETE' });
                loadScheduledExams();
            } catch(e) { alert("ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุณูุฑูุฑ"); }
        }
    }

    async function loadPDFs() {
        try {
            const res = await fetch(`${API_URL}/api/admin/summaries_list`);
            const data = await res.json();
            const tbody = document.getElementById('pdfs-table-body');
            if(data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; opacity:0.6;">ูุง ุชูุฌุฏ ูููุงุช ูุฑููุนุฉ ุญุงููุงู</td></tr>`;
                return;
            }
            tbody.innerHTML = data.map(pdf => `
                <tr>
                    <td>${pdf.lesson}</td>
                    <td><a href="${API_URL}/${pdf.pdf_url}" target="_blank" style="color:var(--gold); font-weight:bold; text-decoration:none;">ุนุฑุถ ุงูููู ๐๏ธ</a></td>
                    <td>
                        <button onclick="editPDF('${pdf.lesson}')" style="background:var(--gold); border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-weight:bold;">ุชุนุฏูู โ๏ธ</button>
                        <button onclick="deletePDF('${pdf.lesson}')" style="background:#ff5e5e; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; color:white; font-weight:bold;">ุญุฐู ๐๏ธ</button>
                    </td>
                </tr>`).join('');
        } catch(e) { console.error("ุฎุทุฃ ูู ุฌูุจ ุงููููุงุช"); }
    }

    async function deletePDF(lesson) {
        if(confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ููุงูุฉ ุงูุฏุฑุณ: ${lesson} ุจุดูู ููุงุฆูุ`)) {
            const safeLessonName = encodeURIComponent(lesson);
            try {
                await fetch(`${API_URL}/api/admin/summaries/${safeLessonName}`, { method: 'DELETE' });
                alert("ุชู ุงูุญุฐู ุจูุฌุงุญ!");
                loadPDFs(); 
            } catch(e) { alert("ูุดู ุงูุญุฐู. ุชุฃูุฏ ูู ุงุชุตุงู ุงูุณูุฑูุฑ."); }
        }
    }

    function editPDF(lesson) {
        document.getElementById('pdf-lesson-select').value = lesson;
        window.scrollTo({ top: 0, behavior: 'smooth' });
        alert("ูุชุนุฏูู ุงููููุ ูู ุจุงุฎุชูุงุฑ ุงูููู ุงูุฌุฏูุฏ ูู ุฌูุงุฒู ูุงุถุบุท 'ุฅูุฏุงุน' ููุชู ุงุณุชุจุฏุงู ุงูููู ุงููุฏูู ุชููุงุฆูุงู.");
    }

    async function uploadSmartPDF() {
        const lesson = document.getElementById('pdf-lesson-select').value;
        const fileInput = document.getElementById('pdf-file-input');
        const status = document.getElementById('pdf-status');
        if(!lesson || !fileInput.files[0]) {
            status.style.color = "#ff5e5e"; status.innerText = "โ๏ธ ูุฑุฌู ุงุฎุชูุงุฑ ุงูุฏุฑุณ ูุงูููู ุฃููุงู!"; return;
        }
        const file = fileInput.files[0];
        if(file.type !== "application/pdf") {
            status.style.color = "#ff5e5e"; status.innerText = "โ๏ธ ูุฑุฌู ุงุฎุชูุงุฑ ููู ุจุตูุบุฉ PDF ููุท."; return;
        }
        const formData = new FormData();
        formData.append('lesson', lesson);
        formData.append('pdf', file);
        try {
            status.style.color = "#d4af37"; status.innerText = "ุฌุงุฑู ุฅูุฏุงุน ุงูููุงูุฉ ูู ุงูุฎุฒูุฉ ุงูุญููููุฉ (ุงูุณูุฑูุฑ)...";
            const res = await fetch(`${API_URL}/api/admin/summaries`, { method: 'POST', body: formData });
            if(res.ok) {
                status.style.color = "#00ff00"; status.innerText = "โจ ุชู ุฑูุน ููุฎุต ุงูุฏุฑุณ ูุญูุธู ูู ุงูุณูุฑูุฑ ุจูุฌุงุญ!";
                fileInput.value = ""; loadPDFs(); 
            } else { status.style.color = "#ff5e5e"; status.innerText = "โ ูุดู ุงูุฑูุน."; }
        } catch(e) { status.style.color = "#ff5e5e"; status.innerText = "โ๏ธ ุงููุญุฑู ูุชููู! ุชุฃูุฏ ูู ุชุดุบูู ุงูุณูุฑูุฑ."; }
    }
    
    async function loadQuestions() {
        try {
            const res = await fetch(`${API_URL}/api/admin/questions`);
            allQuestions = await res.json();
            const tbody = document.getElementById('questions-table-body');
            tbody.innerHTML = allQuestions.map(q => `
                <tr>
                    <td>${q.question.substring(0, 50)}...</td>
                    <td>${q.lesson}</td>
                    <td>${q.image_url ? `<img src="${API_URL}/${q.image_url}" width="40" style="border-radius:5px;">` : '๐'}</td>
                    <td>
                        <button onclick="editQuestion(${q.id})" style="background:var(--gold); border:none; padding:5px; border-radius:5px; cursor:pointer;">โ๏ธ</button>
                        <button onclick="deleteQuestion(${q.id})" style="background:#ff5e5e; border:none; padding:5px; border-radius:5px; cursor:pointer; color:white;">๐๏ธ</button>
                    </td>
                </tr>`).join('');
        } catch(e) { console.error("ุงููุญุฑู ุบูุฑ ูุชุตู"); }
    }

    async function saveSmartQuestion() {
        const status = document.getElementById('status-msg');
        const editId = document.getElementById('edit-id').value;
        const formData = new FormData();
        const lesson = document.getElementById('q-lesson').value;
        const qType = document.getElementById('q-type').value;
        const question = document.getElementById('q-text').value;
        const answer = document.getElementById('q-answer').value;
        const options = document.getElementById('q-options').value;
        const imageFile = document.getElementById('q-image').files[0];

        if(!lesson || !question || !answer) {
            status.style.color = "#ff5e5e"; status.innerText = "โ๏ธ ูุฑุฌู ุฅููุงู ุงูุฏุฑุณ ููุต ุงูุณุคุงู ูุงูุฅุฌุงุจุฉ!"; return;
        }

        formData.append('grade', "6");
        formData.append('subject', "ุงูุฑูุงุถูุงุช");
        formData.append('lesson', lesson);
        formData.append('q_type', qType);
        formData.append('question', question);
        formData.append('options', options || (qType === 'true_false' ? "ุตูุงุจ,ุฎุทุฃ" : "")); 
        formData.append('answer', answer);
        if(imageFile) formData.append('image', imageFile);

        const url = editId ? `${API_URL}/api/admin/questions/${editId}` : `${API_URL}/api/admin/questions`;
        const method = editId ? 'PUT' : 'POST';

        try {
            status.style.color = "#d4af37"; status.innerText = "ุฌุงุฑู ุงูุงุชุตุงู ุจุงูุฎุฒูุฉ...";
            const res = await fetch(url, { method: method, body: formData });
            if(res.ok) { alert("โจ ุชู ุงูุญูุธ ุจูุฌุงุญ!"); resetForm(); loadQuestions(); }
            else { status.innerText = "โ ุฎุทุฃ ูู ุงูุจูุงูุงุช ุฃู ุงูุณูุฑูุฑ."; }
        } catch(e) { status.innerText = "โ๏ธ ุงููุญุฑู ูุชููู! ุชุฃูุฏ ูู ุชุดุบูู ุงูุฎุงุฏู."; }
    }

    function editQuestion(id) {
        const q = allQuestions.find(item => item.id === id);
        if(!q) return;
        document.getElementById('edit-id').value = q.id;
        document.getElementById('q-text').value = q.question;
        document.getElementById('q-answer').value = q.answer;
        document.getElementById('q-options').value = q.options;
        document.getElementById('q-type').value = q.q_type;
        document.getElementById('form-title').innerText = "โ๏ธ ุชุนุฏูู ุงูุชุญุฏู ุงูุญุงูู";
        document.getElementById('save-btn').innerText = "ุชุญุฏูุซ ุงูุณุคุงู ุงููููู โจ";
        document.getElementById('cancel-btn').style.display = "block";
        toggleOptions(); window.scrollTo(0, 0);
    }

    function resetForm() {
        document.getElementById('edit-id').value = "";
        document.getElementById('q-text').value = "";
        document.getElementById('q-answer').value = "";
        document.getElementById('q-options').value = "";
        document.getElementById('form-title').innerText = "๐จ ุฅุถุงูุฉ ุชุญุฏู ูููู ุฌุฏูุฏ";
        document.getElementById('save-btn').innerText = "ุญูุธ ุงูุณุคุงู ูู ุงูุฎุฒูุฉ ๐พ";
        document.getElementById('cancel-btn').style.display = "none";
        document.getElementById('status-msg').innerText = "";
    }

    async function deleteQuestion(id) {
        if(confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุชุญุฏู ููุงุฆูุงูุ")) {
            await fetch(`${API_URL}/api/admin/questions/${id}`, { method: 'DELETE' });
            loadQuestions();
        }
    }
</script>
</body>

</html>
